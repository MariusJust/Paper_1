
import numpy as np

import pandas as pd
from shapely.geometry import Point, Polygon, MultiPolygon, shape
from shapely.prepared import prep
from rtree import index
from tqdm import tqdm   # optional, nice progress bar


def region_to_gridpoints(metadata, grid_points):
    
    n_points = grid_points.shape[0] 
    # ---------- 1) Build R-tree of points ----------
    pt_idx = index.Index()
    for pi, (lon, lat) in enumerate(grid_points):
        pt_idx.insert(pi, (lon, lat, lon, lat))

    # ---------- 2) Prepare assigned mask and outputs ----------
    assigned = np.zeros(n_points, dtype=bool)      # True when a point is already mapped
    assignments = np.full(n_points, -1, dtype=int) # polygon index for each point, -1 = unassigned
    region_to_points = {}                          # fid -> list of (lon, lat)

    
    # ---------- 3) Iterate polygons (recommended) ----------
    for poly_i, row in tqdm(metadata.reset_index(drop=True).iterrows(), total=len(metadata)):
        poly = row['polygon']
        if poly.is_empty:
            continue
        prepared = prep(poly)                       # speed up repeated tests
        fid = row['fid']
        iso3 = row['iso3']
        region_name = row['region']

        # candidate point indices within polygon bounding box
        cand_ids = list(pt_idx.intersection(poly.bounds))

        # filter out already assigned candidates (faster to check mask in Python)
        # iterate remaining candidate ids and test precise containment
        assigned_list = []
        for pi in cand_ids:
            if assigned[pi]:
                continue
            lon, lat = grid_points[pi]
            # use prepared.covers for point-in-polygon test (covers includes boundary)
            if prepared.covers(Point(lon, lat)):
                assigned[pi] = True
                assignments[pi] = poly_i
                region_to_points.setdefault(fid, []).append((float(lon), float(lat)))
                assigned_list.append(pi)
        # finished polygon

    # ---------- 4) Build DataFrame mapping (lon, lat -> polygon) ----------
    rows = []
    for pi, poly_i in enumerate(assignments):
        if poly_i == -1:
            continue
        lon, lat = grid_points[pi]
        row = metadata.iloc[poly_i]
        rows.append({
            'lon': float(lon),
            'lat': float(lat),
            'fid': row['fid'],
            'iso3': row['iso3'],
            'region': row['region'],
            'poly_index': int(poly_i)
        })

    mapping_df = pd.DataFrame(rows)

    # ---------- 5) Unassigned points ----------
    unassigned_points = grid_points[~assigned]  # Nx2 array of points not in any polygon


    rows=[]
    for k in range(n_regions):
            fid_key = instance[k].get('properties').get('fid')
            rows.append({
                'fid': fid_key,
                'iso3': instance[k].get('properties').get('iso3'),
                'region': instance[k].get('properties').get('Subnat'),
                'coordinates': instance[k].get('geometry').get('coordinates'),
                'polygon':shape({"type": "Polygon", "coordinates": instance[k].get('geometry').get('coordinates')}) if isinstance(instance[k].get('geometry').get('coordinates')[0][0][0], (float, int)) else shape({"type":"MultiPolygon", "coordinates": instance[k].get('geometry').get('coordinates')}),
                'lon_lat_points': region_to_points.get(fid_key, [])     
            })
            
    return pd.DataFrame(rows)
    
    